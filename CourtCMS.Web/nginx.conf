# ============================================================
# NGINX CONFIGURATION FOR COURTCMS
# ============================================================
# Nginx does TWO jobs here:
#
# 1. SERVES the Angular app (HTML, CSS, JS files)
# 2. PROXIES /api requests to the .NET backend
#
# This replaces Angular's proxy.conf.json from development.
# In dev, 'ng serve' handled the proxy. In production, Nginx
# takes over that responsibility.
# ============================================================

server {
    listen 80;
    server_name localhost;

    # Where the Angular files live inside the container
    root /usr/share/nginx/html;
    index index.html;

    # ----------------------------------------------------------
    # API PROXY
    # ----------------------------------------------------------
    # Any request starting with /api/ gets forwarded to the
    # .NET API backend. The browser never talks to the API
    # directly — Nginx acts as a middleman.
    #
    # In docker-compose, "api" is the service name, which
    # Docker's internal DNS resolves to the API container's IP.
    # ----------------------------------------------------------
    location /api/ {
        proxy_pass http://api:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ----------------------------------------------------------
    # SPA FALLBACK ROUTING
    # ----------------------------------------------------------
    # This is critical for Angular (or any SPA).
    #
    # When a user navigates to /cases/5 in the browser and
    # hits refresh, the browser asks Nginx for the file
    # /cases/5 — which doesn't exist on disk. Without this
    # rule, Nginx would return a 404.
    #
    # try_files says:
    #   1. Try to serve the literal file ($uri)
    #   2. Try to serve it as a directory ($uri/)
    #   3. If neither exists, serve index.html instead
    #
    # Angular's router then reads the URL and renders the
    # correct component. This is how SPA routing works in
    # production.
    # ----------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ----------------------------------------------------------
    # STATIC ASSET CACHING
    # ----------------------------------------------------------
    # Angular's production build adds unique hashes to filenames
    # (e.g. main.a1b2c3.js). Since the filename changes whenever
    # the content changes, we can safely cache these files for a
    # long time. This makes repeat visits load instantly.
    # ----------------------------------------------------------
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
