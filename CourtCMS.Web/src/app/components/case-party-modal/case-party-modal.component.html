@if (isOpen) {
  <div class="modal-backdrop" (click)="onClose()">
    <div class="modal-container" (click)="onModalClick($event)">
      <div class="modal-header">
        <h3>Add Party to Case</h3>
        <button class="btn-close-x" (click)="onClose()" aria-label="Close modal">&times;</button>
      </div>

      <div class="modal-body">
        @if (filteredParties.length === 0) {
          <div class="empty-state">
            <p>All parties have already been assigned to this case.</p>
            <p class="hint">You can add new parties from the Party Directory.</p>
          </div>
        } @else {
          <form [formGroup]="casePartyForm" (ngSubmit)="onSubmit()" id="casePartyForm">
            <fieldset [disabled]="isSaving">
              <!-- SELECT PARTY -->
              <div class="form-group">
                <label for="partyId">Select Party</label>
                <select
                  id="partyId"
                  formControlName="partyId"
                  [class.invalid]="showError('partyId')"
                >
                  <option [ngValue]="null" disabled>-- Select a Party --</option>
                  @for (party of filteredParties; track party.id) {
                    <option [ngValue]="party.id">
                      {{ party.lastName }}, {{ party.firstName }}
                    </option>
                  }
                </select>
                @if (showError('partyId')) {
                  <span class="error-message">Please select a party.</span>
                }
              </div>

              <!-- ROLE IN CASE -->
              <div class="form-group">
                <label for="role">Role in Case</label>
                <select id="role" formControlName="role" [class.invalid]="showError('role')">
                  <option value="" disabled>-- Select a Role --</option>
                  @for (role of roles; track role) {
                    <option [value]="role">{{ role }}</option>
                  }
                </select>
                @if (showError('role')) {
                  <span class="error-message">Please select a role.</span>
                }
              </div>
            </fieldset>
          </form>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" type="button" (click)="onClose()">Cancel</button>
        @if (filteredParties.length > 0) {
          <button class="btn-save" type="submit" form="casePartyForm" [disabled]="isSaving">
            {{ isSaving ? 'Saving...' : 'Add to Case' }}
          </button>
        }
      </div>
    </div>
  </div>
}
